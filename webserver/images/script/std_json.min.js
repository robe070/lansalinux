/*!
	(c) 2011, 2014 LANSA
	JSON handler scripts
	$Workfile:: std_json.js                 $
	$UTCDate:: 2014-02-26 22:15:32Z         $
	$Revision:: 24                          $
*/
var Lstd=Lstd||{};Lstd.Json={Internal:{findSubobject:function(o,type,parent){var subobj={id:null,obj:null};try{switch(typeof o){case"string":subobj.id=o;subobj.obj=parent[o];if(!subobj.obj){throw (type+" "+o+" not found.");}break;case"number":subobj.id=Lstd.Utils.getPropertyNameAtIndex(parent,o);if(subobj.id==null){throw type+" not found at index "+o+".";
}subobj.obj=parent[subobj.id];break;default:throw"Argument of type "+(typeof o)+" not valid. Must be a name or index.";break;}}catch(e){console.error(e);}return subobj;},createWebroutine:function(){var obj={"webroutine":{"messages":[],"fields":{},"lists":{}}};var lmxlSKMethod=Lstd.Webroutine.getContext("session-key-method");var lxmlSK=Lstd.Webroutine.getContext("session-key");if(lmxlSKMethod&&lxmlSK&&(lmxlSKMethod==="hidden")&&(lxmlSK!=="")){obj.webroutine["context"]={};obj.webroutine.context["session-key"]=lxmlSK;
obj.webroutine.context["session-key-method"]="hidden";obj.webroutine.context["session-key-name"]=Lstd.Webroutine.getContext("session-key-name");}return obj;}},Messages:function(args){this.messages=args?args:[];this.count=function(){return this.messages.length;};this.each=function(func){try{if(typeof func=="function"){for(var i=0;i<this.messages.length;i++){func(this.messages[i]);}}}catch(e){console.error(e);throw e;}};this.add=function(s){if(typeof s=="string"){this.messages.push(s);}else{this.messages.push(""+s);
}return this;};},Field:function(args){this.id=args.id;this.field=args.obj;this.name=function(){return this.id;};this.label=function(){return this.field.caption.label;};this.description=function(){return this.field.caption.description;};this.headings=function(){var caption=this.field.caption;return[caption["heading-1"]?caption["heading-1"]:"",caption["heading-2"]?caption["heading-2"]:"",caption["heading-3"]?caption["heading-3"]:"",];};this.value=function(){return this.field.value;};},Fields:function(fields){this.fields=fields;
this.each=function(func){try{if(typeof func=="function"){for(var fld in this.fields){func(new Lstd.Json.Field({id:fld,obj:this.fields[fld]}));}}}catch(e){console.error(e);throw e;}};},ListHeader:function(header){this.header=header;this.name=function(){return this.header.name;};this.headings=function(){var h=this.header;return[h["heading-1"]?h["heading-1"]:"",h["heading-2"]?h["heading-2"]:"",h["heading-3"]?h["heading-3"]:"",];};},ListHeaders:function(args){this.id=args.id;this.headers=args.obj;this.findByName={};
for(var i=0,hdr;hdr=this.headers[i];i++){this.findByName[hdr.name]=i;}this.indexOf=function(name){var index=this.findByName[name];return index>=0?index:-1;};this.col=function(name){var index=this.indexOf(name);return index>=0?new Lstd.Json.ListHeader(this.headers[index]):null;};this.each=function(func){try{if(typeof func=="function"){for(var i=0,hdr;hdr=this.headers[i];i++){func(new Lstd.Json.ListHeader(hdr));}}}catch(e){console.error(e);throw e;}return this;};},ListEntry:function(args){this.rowNumber=args.rowNumber;
this.listHeader=args.header;this.entry=args.obj;this.row=function(){return this.rowNumber;};this.col=function(name){var index=this.listHeader.indexOf(name);return index>=0?this.entry[index]:null;};this.columnId=function(name){var index=this.listHeader.indexOf(name);return index>=0?(this.listHeader.id+"."+this.rowNumber.zeropad(4)+"."+name):null;};this.each=function(func){try{if(typeof func=="function"){for(var i=0,col;col=this.entry[i];i++){func(col);}}}catch(e){console.error(e);throw e;}};return this;
},ListEntries:function(args){this.listHeader=args.header;this.entries=args.obj;this.rowCount=function(){return this.entries?this.entries.length:0;};this.columnCount=function(){return this.entries?(this.entries.length>0?this.entries[0].length:0):0;};this.each=function(func){try{if(typeof func=="function"){for(var i=0,entry;entry=this.entries[i];i++){func(new Lstd.Json.ListEntry({rowNumber:i+1,header:this.listHeader,obj:entry}));}}}catch(e){console.error(e);throw e;}};this.rawEach=function(func){try{if(typeof func=="function"){for(var i=0,entry;
entry=this.entries[i];i++){func(i,entry);}}}catch(e){console.error(e);throw e;}};this.transpose=function(){var entries=[];var nCols=this.entries.length;var nRows=nCols>0?this.entries[0].length:0;if(nCols&&nRows){entries=new Array(nRows);for(var i=0;i<nRows;i++){entries[i]=new Array(nCols);for(var j=0;j<nCols;j++){entries[i][j]=this.entries[j][i];}}}return new Lstd.Json.ListEntries({header:null,obj:entries});};this.add=function(row){this.entries.push(row);};},List:function(args){this.id=args.id;this.list=args.obj;
this.listHeader=new Lstd.Json.ListHeaders({id:this.id,obj:this.list.header});this.listEntries=new Lstd.Json.ListEntries({header:this.listHeader,obj:this.list.entries});this.name=function(){return this.id;};this.headers=function(cols){if(cols==null){return this.listHeader;}else{if(cols instanceof Array){this.list.header=[];for(var i=0;i<cols.length;i++){this.list.header.push({"name":cols[i]});}this.list.entries=[];this.listHeader=new Lstd.Json.ListHeaders({id:this.id,obj:this.list.header});this.listEntries=new Lstd.Json.ListEntries({header:this.listHeader,obj:this.list.entries});
}else{throw"Argument is not array of column names.";}}};this.entries=function(){return this.listEntries;};this.toJSON=function(){var tmp={"list":{}};tmp.list[this.id]=this.list;return tmp;};this.post=function(args){var wr=Lstd.Json.Internal.createWebroutine();wr.webroutine.lists[this.id]=this.list;Lstd.Json.post(args,wr);};},Lists:function(lists){this.lists=lists;this.each=function(func){try{if(typeof func=="function"){for(var list in this.lists){func(new Lstd.Json.List({id:list,obj:this.lists[list]}));
}}}catch(e){console.error(e);throw e;}};},Wr:function(wr){this.webroutine=wr;this.context=function(item){return this.webroutine.context[item];};this.messages=function(){return new Lstd.Json.Messages(this.webroutine.messages);};this.fields=function(){return new Lstd.Json.Fields(this.webroutine.fields);};this.lists=function(){return new Lstd.Json.Lists(this.webroutine.lists);};this.field=function(o,v){if(v==null){var fld=Lstd.Json.Internal.findSubobject(o,"field",this.webroutine.fields);return fld.obj?new Lstd.Json.Field(fld):null;
}else{if(typeof o!="string"){throw"Field name required!";}this.webroutine.fields[o]={"value":v};}};this.list=function(o){var lst=Lstd.Json.Internal.findSubobject(o,"list",this.webroutine.lists);return lst.obj?new Lstd.Json.List(lst):null;};this.addList=function(name){var lst=Lstd.Json.Internal.findSubobject(name,"list",this.webroutine.lists);if(lst.obj){return new Lstd.Json.List(lst);}else{this.webroutine.lists[name]={"header":[],"entries":[]};return this.list(name);}};this.post=function(args){Lstd.Json.post(args,this);
};},factory:function(obj){if(obj==null){obj=Lstd.Json.Internal.createWebroutine();}var otype=Lstd.Utils.getPropertyNameAtIndex(obj,0);switch(otype){case"webroutine":return new Lstd.Json.Wr(obj[otype]);break;case"list":var lst=Lstd.Json.Internal.findSubobject(0,"list",obj[otype]);return lst?new Lstd.Json.List(lst):null;break;}return null;},isWebroutine:function(obj){return(obj!=null)?((Lstd.Utils.getPropertyNameAtIndex(obj,0)=="webroutine")?true:false):false;},getWebroutine:function(args){var request=new Lstd.HTTP.Request();
if(args.wam){request.wam=args.wam;}if(args.webroutine){request.webroutine=args.webroutine;}if(args.fields){request.addFields(args.fields);}if(args.lists){for(listName in args.lists){request.addList(listName,args.lists[listName]);}}try{Lstd.HTTP.getWebroutine(request,args.callback);}catch(e){console("Lstd.Json.getWebroutine(): "+e);}},toJSON:function(){return this.webroutine;},post:function(args,o){var request=new Lstd.HTTP.Request();request.method="POST";if(args.wam){request.wam=args.wam;}if(args.webroutine){request.webroutine=args.webroutine;
}jQuery.ajax({url:request.getURL(),type:request.method,cache:request.cache,dataType:"json",contentType:"application/json",data:JSON.stringify(o),scriptCharset:"utf-8",success:function(data){var wr=(Lstd.Json)?Lstd.Json.factory(data):data;if(jQuery.isFunction(args.callback)){args.callback(wr);}},error:function(xhr,s,e){console.error("JSON response: "+s);}});}};